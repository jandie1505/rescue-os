name: Build Debian Live (privileged container)

on:
  #push:
  #  branches: [ "main" ]
  schedule:
    - cron: "15 2 1 1,3,5,7,9,11 *"    # monatlich, 02:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull Debian image
        run: docker pull debian:trixie

      - name: Build ISO inside privileged Debian container
        run: |
          docker run --rm \
            --privileged \
            -v "$PWD":/work \
            -w /work \
            --security-opt seccomp=unconfined \
            debian:trixie bash -euo pipefail -lc '
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                live-build xorriso syslinux-common isolinux ca-certificates git coreutils sudo

              chmod +x ./build.sh
              ./build.sh

              test -f live-build/live-image-amd64.hybrid.iso
            '

      - name: SHA256 & size
        run: |
          ls -lh live-build/live-image-amd64.hybrid.iso
          sha256sum live-build/live-image-amd64.hybrid.iso > live-build/live-image-amd64.hybrid.iso.sha256
          cat live-build/live-image-amd64.hybrid.iso.sha256

      # Ephemeral artifact
      - name: Upload artifact (ephemeral)
        uses: actions/upload-artifact@v4
        with:
          name: rescue-os-iso
          path: |
            live-build/live-image-amd64.hybrid.iso
            live-build/live-image-amd64.hybrid.iso.sha256
          if-no-files-found: error
          compression-level: 0
          retention-days: 90

      # Prepare release metadata
      - name: Prepare release metadata
        id: meta
        shell: bash
        env:
          ISO_URL: "https://files.chaossquad.net/rescueos/live-image-amd64.hybrid.iso"
        run: |
          DATE_UTC="$(date -u +%F)"                # YYYY-MM-DD (UTC)
          SHORT_SHA="${GITHUB_SHA::7}"

          echo "date=${DATE_UTC}" >> "$GITHUB_OUTPUT"
          echo "tag=${DATE_UTC}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "name=Rescue OS ${DATE_UTC}" >> "$GITHUB_OUTPUT"

          {
            echo "Automated build on ${DATE_UTC} (UTC)."
            echo
            echo "Commit: ${GITHUB_SHA}"
            echo "Tag: ${DATE_UTC}-${SHORT_SHA}"
            echo "Workflow run: [${GITHUB_RUN_ID}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})"
            echo
            echo "---"
            echo
            echo "You can download Rescue OS here:  "
            echo
            echo "**[Download (latest)](${ISO_URL})**  "
            echo "[Download (from GitHub Actions, requires login)](${ARTIFACT_URL})  "
            echo
            echo "Since the ISO image is to large to upload it to GitHub Releases, I had to upload it to my own server. It only stores the [latest release](https://github.com/jandie1505/rescue-os/releases/latest).  "
            echo "You can also download the current release from GitHub Actions, but you need to be signed in on GitHub to do so. If you're not, you'll get an error 404 when you click on that link.  "
            echo
            echo "You can verify the ISO image with the .sha256 file attached on this release."
            echo
            echo ---
            echo
            echo "Please ensure that you have read the [README](https://github.com/jandie1505/rescue-os/blob/main/README.md) before downloading."
            echo

          } > body.txt

          echo "bodyfile=body.txt" >> "$GITHUB_OUTPUT"

      # Create version.txt
      - name: Create version file
        shell: bash
        env:
          RELEASE_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          echo "${RELEASE_TAG}" > live-build/version.txt
          cat live-build/version.txt

      # Release erstellen & Assets hochladen
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          body_path: ${{ steps.meta.outputs.bodyfile }}
          draft: false
          prerelease: false
          files: |
            live-build/live-image-amd64.hybrid.iso.sha256

      # Setup SSH key
      - name: Install SSH key for upload
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.UPLOAD_SERVER_PRIVKEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh-keyscan -H "${{ secrets.UPLOAD_SERVER_HOST }}" >> ~/.ssh/known_hosts

      # Upload ISO + SHA256 + version.txt
      - name: Upload ISO, checksum and version to external server (atomic ISO update)
        shell: bash
        run: |
          ISO_LOCAL="live-build/live-image-amd64.hybrid.iso"
          SHA_LOCAL="live-build/live-image-amd64.hybrid.iso.sha256"
          VERSION_LOCAL="live-build/version.txt"

          ISO_REMOTE_DIR="/var/www/rescueos-upload"
          ISO_REMOTE_NAME="live-image-amd64.hybrid.iso"
          SHA_REMOTE_NAME="live-image-amd64.hybrid.iso.sha256"
          VERSION_REMOTE_NAME="version.txt"

          ISO_REMOTE_TMP="${ISO_REMOTE_NAME}.tmp"

          # 1. Upload as temporary file
          scp "$ISO_LOCAL" \
            "${{ secrets.UPLOAD_SERVER_USER }}@${{ secrets.UPLOAD_SERVER_HOST }}:${ISO_REMOTE_DIR}/${ISO_REMOTE_TMP}"

          # 2. Make uploaded file the new version
          ssh "${{ secrets.UPLOAD_SERVER_USER }}@${{ secrets.UPLOAD_SERVER_HOST }}" \
            "cd '${ISO_REMOTE_DIR}' && mv '${ISO_REMOTE_TMP}' '${ISO_REMOTE_NAME}'"

          # 3. Update checksum and version.txt
          scp "$SHA_LOCAL" \
            "${{ secrets.UPLOAD_SERVER_USER }}@${{ secrets.UPLOAD_SERVER_HOST }}:${ISO_REMOTE_DIR}/${SHA_REMOTE_NAME}"

          scp "$VERSION_LOCAL" \
            "${{ secrets.UPLOAD_SERVER_USER }}@${{ secrets.UPLOAD_SERVER_HOST }}:${ISO_REMOTE_DIR}/${VERSION_REMOTE_NAME}"
